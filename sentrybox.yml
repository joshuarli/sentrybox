images:
  - location: "https://cloud-images.ubuntu.com/minimal/releases/noble/release/ubuntu-24.04-minimal-cloudimg-arm64.img"
    arch: aarch64

ssh:
  forwardAgent: true

vmType: vz
cpus: 4
memory: 8GiB
# will grow dynamically; QCOW2 remains sparse until written
disk: "64GiB"

provision:
  - mode: system
    script: |
      #!/bin/bash
      set -eux
      apt-get update
      apt-get install -y git curl make docker.io
      systemctl enable docker
      systemctl start docker

      # create nonroot user (idempotent)
      id claude &>/dev/null || useradd -m -s /bin/bash claude
      usermod -aG docker claude

      # helper script: opens the SSH agent socket to claude, then switches user
      cat > /usr/local/bin/claude-shell << 'SHELL'
      #!/bin/bash
      if [ -n "$SSH_AUTH_SOCK" ] && [ -S "$SSH_AUTH_SOCK" ]; then
        chmod o+rx "$(dirname "$SSH_AUTH_SOCK")"
        chmod o+rw "$SSH_AUTH_SOCK"
        exec sudo --preserve-env=SSH_AUTH_SOCK -iu claude
      else
        exec sudo -iu claude
      fi
      SHELL
      chmod +x /usr/local/bin/claude-shell

      snap install astral-uv --classic

      curl -fsSL https://raw.githubusercontent.com/getsentry/devenv/main/install-devenv.sh \
        -o /home/claude/install-devenv.sh
      chown claude:claude /home/claude/install-devenv.sh

      sudo -iu claude bash install-devenv.sh

      # currently this'll fail due to post_fetch complaining we need to install chromium-chromedriver
      sudo -iu claude devenv fetch sentry || true

      sudo -iu claude bash -c 'cd ~/code/sentry && SENTRY_DEVENV_SKIP_FRONTEND=1 devenv sync'


containerd:
  system: false
  user: false
