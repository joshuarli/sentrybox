images:
  - location: "https://cloud-images.ubuntu.com/minimal/releases/noble/release/ubuntu-24.04-minimal-cloudimg-arm64.img"
    arch: aarch64

ssh:
  forwardAgent: true

vmType: vz
cpus: 4
memory: 8GiB
# will grow dynamically; QCOW2 remains sparse until written
disk: "64GiB"

mounts:
  # XXX: {{.Dir}} resolves to /Users/josh/.lima/sentrybox, not here
  - location: "/Users/josh/dev/sentry-vm/bin"
    mountPoint: /etc/sentrybox/bin
    writable: false

# does this run on limactl start after a stop?
# if so we need to make things idempotent
provision:
  - mode: system
    script: |
      #!/bin/bash
      set -eux

      apt-get update
      apt-get install -y --no-install-recommends git curl make docker.io
      systemctl enable docker
      systemctl start docker

      # this is hilariously slow; we'll install uv with astral's install.sh in /etc/sentrybox/bin/
      # snap install astral-uv --classic

      # create nonroot user (idempotent)
      id claude &>/dev/null || useradd -m -s /bin/bash claude
      usermod -aG docker claude

      sudo -iu claude /etc/sentrybox/bin/setup-claude.sh
      sudo -iu claude /etc/sentrybox/bin/sync-backend.sh

portForwards:
  - guestPortRange: [1, 65535]
    ignore: true

containerd:
  system: false
  user: false
