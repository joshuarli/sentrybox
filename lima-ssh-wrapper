#!/bin/sh

# This runs as the Lima user (who has sudo), opens the
# socket permissions, then switches to claude with
# SSH_AUTH_SOCK preserved.

if [ -z "$SSH_AUTH_SOCK" ] || [ ! -S "$SSH_AUTH_SOCK" ]; then
  echo "Error: SSH_AUTH_SOCK is not set or invalid." >&2
  echo "Run: ssh-add ~/.ssh/sentry-github" >&2
  exit 1
fi

if [ $# -eq 0 ]; then
  exec ssh -t -F "${HOME}/.lima/${LIMA_VM_NAME}/ssh.config" "lima-${LIMA_VM_NAME}" "
    chmod o+rx \"\$(dirname \"\$SSH_AUTH_SOCK\")\"
    chmod o+rw \"\$SSH_AUTH_SOCK\"
    sudo --preserve-env=SSH_AUTH_SOCK -iu claude bash -c 'cd /home/claude/code/sentry && exec bash'
  "
else
  exec ssh -F "${HOME}/.lima/${LIMA_VM_NAME}/ssh.config" "lima-${LIMA_VM_NAME}" "
    chmod o+rx \"\$(dirname \"\$SSH_AUTH_SOCK\")\"
    chmod o+rw \"\$SSH_AUTH_SOCK\"
    sudo --preserve-env=SSH_AUTH_SOCK -iu claude bash -c 'cd /home/claude/code/sentry && \"\$@\"' -- $*
  "
fi
